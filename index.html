<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Equalizer</title>
    <link type="text/css" rel="stylesheet" href="./styles/main.css" />
  </head>
  <body>
    <div id="content">
      <div id="tool" class="column"></div>
      <div id="description" class="column">
        <h1 id="title">Equalizer</h1>
        <p>
          <span class="symbols">O</span>An audio analysis tool for real-time and choreographed visualizations.
        </p>
        <p id="links">
          <a href="http://github.com/jonobr1/equalizer">Source Code</a> &middot; <a href="https://github.com/jonobr1/equalizer/blob/master/license.txt" target="_blank">MIT</a>
        </p>
        <p id="instructions">
          Start by dragging an audio file &mdash; preferably a wav, mp3, or ogg &mdash; onto the gray outline box above. Once loaded a rotated <a class="explanation" href="https://en.wikipedia.org/wiki/Staff_(music)" target="_blank">staff</a> will be displayed. Hit the <span id="spacebar" class="action">spacebar</span> to play and pause the music. Once audio starts playing you&apos;ll notice some visual activity, <span id="bands"></span> bands representing different amplitudes at equally spaced frequency bandwidths.
        </p>
        <!-- <p>
          You can also <span id="export" class="action">export</span> and <span id="import" class="action">import</span> data as JSON with the below text field:
          <br />
          <textarea width="300" height="200"></textarea>
        </p> -->
        <br />
        <!-- <h2 id="examples">
          Examples
        </h2>
        <p>
          This page is one example of how to use Equalizer, but there are other ways it can be used. Check them out below:
        </p>
        <ul>
          <li>Real-time Analysis</li>
          <li>Choreographed Data</li>
        </ul> -->
        <p id="post-scriptum">
          Created <span id="created-date"></span> and updated <span id="updated-date"></span>.
          <br />
          By <a href="http://jono.fyi/" target="_blank">Jono</a>
          <br />
        </p>
      </div>
    </div>
    <div class="scripts">
      <script type="module">

        import * as qp from './third-party/query-params.js';
        import { Equalizer } from './src/equalizer.js';
        import { Sound } from './src/sound.js';

        if (!Sound.has) {
          throw new Error('Sound: Unable to identify the Web Audio API');
        }

        var params = qp.get();
        var $ = {
          tool: document.querySelector('#tool'),
          spacebar: document.querySelector('#spacebar'),
          bands: document.querySelector('#bands'),
          export: document.querySelector('#export'),
          import: document.querySelector('#import')
        };

        Equalizer.Resolution = typeof params.resolution === 'number' ? params.resolution : 16;

        var context = new (AudioContext || webkitAudioContext)();
        var equalizer = new Equalizer(context).appendTo($.tool);
        var elem = equalizer.domElement;
        var sound;

        elem.style.display = 'inline-block';
        elem.style.margin = '20px';
        elem.style.border = '1px solid #ccc';

        $.bands.textContent = Equalizer.Resolution;

        elem.addEventListener('drop', drop, false);
        elem.addEventListener('dragover', dragover, false);
        elem.addEventListener('dragleave', dragleave);
        elem.addEventListener('click', toggle, false);
        $.spacebar.addEventListener('click', toggle, false);
        // document.querySelector('#export').addEventListener('click', function() {
        //   if (!equalizer.timeline) {
        //     return;
        //   }
        //   var textarea = document.querySelector('textarea');
        //   textarea.innerHTML = JSON.stringify(equalizer.timeline.toJSON());
        // }, false);
        // document.querySelector('#import').addEventListener('click', function() {
        //   var textarea = document.querySelector('textarea');
        //   if (!loop.init) {
        //     loop();
        //     loop.init = true;
        //   }
        // }, false);

        equalizer.update();

        function setup() {
          equalizer.add(sound.gain);
          if (!loop.init) {
            loop();
            loop.init = true;
          }
        }

        function drop(e) {

          e.stopPropagation();
          e.preventDefault();

          elem.style.background = 'transparent';
          var file = e.dataTransfer.files[0];

          if (!file) {
            return;
          }

          var reader = new FileReader();
          reader.onload = function(e) {
            var data = e.target.result;
            if (sound) {
              sound.stop();
            }
            sound = new Sound(context, data, setup);
            sound.url = file.name;
            equalizer.reset();
          };

          reader.readAsArrayBuffer(file);

        }

        function dragover(e) {
          e.stopPropagation();
          e.preventDefault();
          elem.style.background = 'rgba(200, 255, 150, 0.33)';
        }

        function dragleave(e) {
          e.stopPropagation();
          e.preventDefault();
          elem.style.background = 'transparent';
        }

        function loop() {
          requestAnimationFrame(loop);
          equalizer.update();
        }

        function toggle() {
          if (!sound) {
            alert('You need to drop an audio file before the equalizer can run.');
            return;
          }
          if (sound.playing) {
            sound.pause();
          } else {
            sound.play();
          }
        }

        function updateStats() {

          var xhr = new XMLHttpRequest();
          xhr.open('GET', 'https://api.github.com/repos/jonobr1/equalizer');
          xhr.onreadystatechange = function() {
            if (!(xhr.readyState === 4 && xhr.status === 200)) {
              return;
            }
            var resp = JSON.parse(xhr.responseText);
            document.querySelector('#updated-date').innerHTML
              = formatDate(resp.pushed_at);
            document.querySelector('#created-date').innerHTML
              = formatDate(resp.created_at);
          };
          xhr.send();

        }

        function formatDate(time) {
          var date = new Date(time);
          var suffices = ['st', 'nd', 'rd'];
          suffices.getIndex = function(n) {
            var index = parseInt((n + '').slice(-1));
            return index - 1;
          };
          var months = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];
          return [
            months[date.getMonth()],
            ' ',
            date.getDate(),
            '<sup>',
            suffices[suffices.getIndex(date.getDate())] || 'th',
            '</sup>, ',
            date.getFullYear()
          ].join('')
        }

      </script>
    </div>
  </body>
</html>
